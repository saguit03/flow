name: GitFlow Workflow
 
on:
  push:
    branches:
      - main
      - develop
      - "feature/*"
  pull_request:
    branches:
      - develop
  workflow_dispatch:
 
env:
  IMAGE_NAME: ghcr.io/${{ secrets.GHCR_USERNAME }}/terraform-sim
  ENVIRONMENT: dev
 
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    environment: $ENVIRONMENT
 
    steps:
      - name: 🛎️ Checkout del código
        uses: actions/checkout@v4
 
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: 🔨 Construcción de la imagen Docker
        run: docker build -t $IMAGE_NAME:${{ github.sha }} .
 
      - name: 🧪 Prueba de la imagen
        run: docker run --rm $IMAGE_NAME:${{ github.sha }}
 
      - name: 📤 Push de la imagen a GHCR (feature branches)
        if: contains(github.ref, 'feature/')
        run: |
          FEATURE_NAME=$(basename ${{ github.ref }})
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:dev-feature-$FEATURE_NAME
          docker push $IMAGE_NAME:dev-feature-$FEATURE_NAME
 
  deploy-dev:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: contains(github.ref, 'feature/')
    environment: $ENVIRONMENT
 
    steps:
      - name: 🚀 Simulando despliegue en entorno "dev"
        run: |
          FEATURE_NAME=$(basename ${{ github.ref }})
          echo "Desplegando en dev con la imagen $IMAGE_NAME:dev-feature-$FEATURE_NAME"
 
      - name: 🧪 Ejecutando pruebas en dev
        run: |
          echo "✅ Probando la imagen en el entorno dev..."
          sleep 5  # Simula ejecución de tests
          echo "✔️ Pruebas completadas con éxito"
 
  deploy-develop:
    needs: deploy-dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: $ENVIRONMENT
 
    steps:
      - name: 📤 Push de la imagen a GHCR (develop)
        run: |
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
 
  deploy-prod:
    needs: deploy-develop
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: $ENVIRONMENT
 
    steps:
      - name: 📤 Push de la imagen a GHCR (main)
        run: |
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
 
      - name: 🚀 Simulando despliegue en producción
        run: echo "Desplegando en producción con la imagen $IMAGE_NAME:latest"