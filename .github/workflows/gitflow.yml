name: GitFlow Workflow
 
on:
  push:
    branches:
      - main
      - develop
      - "feature/*"
  pull_request:
    branches:
      - develop
  workflow_dispatch:
 
env:
  IMAGE_NAME: ghcr.io/${{ secrets.GHCR_USERNAME }}/terraform-sim
  ENVIRONMENT: dev
 
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    environment: $ENVIRONMENT
 
    steps:
      - name: ğŸ›ï¸ Checkout del cÃ³digo
        uses: actions/checkout@v4
 
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: ğŸ”¨ ConstrucciÃ³n de la imagen Docker
        run: docker build -t $IMAGE_NAME:${{ github.sha }} .
 
      - name: ğŸ§ª Prueba de la imagen
        run: docker run --rm $IMAGE_NAME:${{ github.sha }}
 
      - name: ğŸ“¤ Push de la imagen a GHCR (feature branches)
        if: contains(github.ref, 'feature/')
        run: |
          FEATURE_NAME=$(basename ${{ github.ref }})
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:dev-feature-$FEATURE_NAME
          docker push $IMAGE_NAME:dev-feature-$FEATURE_NAME
 
  deploy-dev:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: contains(github.ref, 'feature/')
    environment: $ENVIRONMENT
 
    steps:
      - name: ğŸš€ Simulando despliegue en entorno "dev"
        run: |
          FEATURE_NAME=$(basename ${{ github.ref }})
          echo "Desplegando en dev con la imagen $IMAGE_NAME:dev-feature-$FEATURE_NAME"
 
      - name: ğŸ§ª Ejecutando pruebas en dev
        run: |
          echo "âœ… Probando la imagen en el entorno dev..."
          sleep 5  # Simula ejecuciÃ³n de tests
          echo "âœ”ï¸ Pruebas completadas con Ã©xito"
 
  deploy-develop:
    needs: deploy-dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: $ENVIRONMENT
 
    steps:
      - name: ğŸ“¤ Push de la imagen a GHCR (develop)
        run: |
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
 
  deploy-prod:
    needs: deploy-develop
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: $ENVIRONMENT
 
    steps:
      - name: ğŸ“¤ Push de la imagen a GHCR (main)
        run: |
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
 
      - name: ğŸš€ Simulando despliegue en producciÃ³n
        run: echo "Desplegando en producciÃ³n con la imagen $IMAGE_NAME:latest"