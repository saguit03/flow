name: GitFlow Workflow
 
on:
  push:
    branches:
      - main
      - develop
      - "feature/*"
  pull_request:
    branches:
      - develop
 
env:
  IMAGE_NAME: ghcr.io/${{ secrets.GHCR_USERNAME }}/terraform-sim
 
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    environment: dev
 
    steps:
      - name: 🛎️ Checkout del código
        uses: actions/checkout@v4
 
      - name: 🔧 Login en GitHub Container Registry
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
 
      - name: 🔨 Construcción de la imagen Docker
        run: docker build -t $IMAGE_NAME:${{ github.sha }} .
 
      - name: 🧪 Prueba de la imagen
        run: docker run --rm $IMAGE_NAME:${{ github.sha }}
 
      - name: 📤 Push de la imagen a GHCR (feature branches)
        if: startsWith(github.ref, 'refs/heads/feature/')
        run: |
          FEATURE_NAME=$(echo ${{ github.ref }} | awk -F'/' '{print $3}')
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:dev-feature-$FEATURE_NAME
          docker push $IMAGE_NAME:dev-feature-$FEATURE_NAME
 
  deploy-dev:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/feature/')
    environment: dev
 
    steps:
      - name: 🚀 Simulando despliegue en entorno "dev"
        run: echo "Desplegando en dev con la imagen $IMAGE_NAME:dev-feature-${{ github.ref_name }}"
 
      - name: 🧪 Ejecutando pruebas en dev
        run: |
          echo "✅ Probando la imagen en el entorno dev..."
          sleep 5  # Simula ejecución de tests
          echo "✔️ Pruebas completadas con éxito"
 
  deploy-develop:
    needs: deploy-dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: dev
 
    steps:
      - name: 📤 Push de la imagen a GHCR (develop)
        run: |
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
 
  deploy-prod:
    needs: deploy-develop
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: dev
 
    steps:
      - name: 📤 Push de la imagen a GHCR (main)
        run: |
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
 
      - name: 🚀 Simulando despliegue en producción
        run: echo "Desplegando en producción con la imagen $IMAGE_NAME:latest"